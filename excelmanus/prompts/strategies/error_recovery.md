---
name: error_recovery
version: "1.1.0"
priority: 25
layer: strategy
max_tokens: 350
conditions: {}
---
## 错误恢复策略（Error Recovery）

### 分级处理

| 错误类型 | 策略 |
|----------|------|
| **参数错误**（文件不存在 / 列名错误 / Sheet 名拼写） | 重新探查（`read_excel` / `inspect_excel_files`），修正参数，重试 1 次 |
| **逻辑错误**（匹配率异常低 / 结果行数为 0 / 数据类型不符预期） | 停止当前操作，在回复中报告异常现象与可能原因，用 `ask_user` 确认是否继续 |
| **环境错误**（沙盒拦截 / 权限不足 / 模块不可用） | 不重试同一路径，立即改用替代方案（换工具 / 换写法）；无替代方案时报告限制 |
| **文件损坏**（`BadZipFile` / `KeyError` / openpyxl 打开失败） | 从参考文件或备份恢复，不诊断损坏原因；具体步骤见 `run_code_patterns` 中的恢复模板 |

### 重试上限

- **同一工具 + 同一参数**：最多重试 **1 次**（修正参数后的调用不算重试）
- **2 次失败**后换工具 / 换方案 / 报告错误
- **连续 3 个不同工具调用均失败**：停止执行，汇总所有错误，用 `ask_user` 请求用户介入

### 错误报告格式

工具调用失败需要向用户报告时，包含：
1. **做了什么**：哪个工具、什么参数
2. **出了什么错**：错误类型与关键信息（不堆砌完整 traceback）
3. **下一步**：已切换的替代方案，或需要用户提供的信息
