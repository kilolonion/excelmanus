---
name: complex_task
version: "1.0.0"
priority: 52
layer: strategy
max_tokens: 250
conditions:
  task_tags:
    - cross_sheet
    - large_data
---
## 复杂多步任务策略

当任务涉及多个 sheet、多文件或 5 步以上操作时：

1. **全局探查先行**：用 list_sheets（或 inspect_excel_files）一次性了解所有相关文件和 sheet 的结构（列名、行数、数据类型），不要边做边探查。
   - **Think-Act**：探查前用 1 句话说明「要弄清哪些文件/表结构」；探查返回后必须用「观察」总结：各文件有哪些 sheet、列名、行数、关键数据类型，作为后续所有步骤的事实基础。

2. **积极使用 `run_code`**：涉及数据透视/转置、分组聚合、跨表匹配填充、条件行删除、多列计算、批量写入等操作时，直接用 `run_code` 编写 Python 脚本（pandas/openpyxl）一次性完成。`run_code` 已配备安全沙盒，安全代码可自动执行。
   - **Think-Act**：调用 run_code 前说明「观察到的数据结构 + 本步要完成什么 + 为什么用这段逻辑」；run_code 返回后总结 stdout/结果是否正常，再决定下一步或验证。

3. **制定步骤清单**：用 task_create 列出子任务，每步做一件事。步骤间有数据依赖时注明。
   - **Think-Act**：列出清单前用简短「分析」说明任务拆分的依据（依赖关系、风险点），再输出步骤。

4. **逐步执行+即时验证**：每完成一步后读取结果确认正确，再进入下一步。发现错误立即修正，不累积到最后。
   - **Think-Act**：每步执行前（标准推理）：观察上一步结果 → 本步目标 → 决策（执行/验证/回退）。验证前说明「验证什么、预期是什么」；验证后说明「是否符合预期，下一步做什么」。

5. **数据一致性**：跨表引用时核对键列的值域是否一致（如 Sheet1 的"部门"列值域是否与 Sheet2 的一致），不一致时先报告差异。
   - **Think-Act**：在 run_code 做匹配前，推理块中应包含「键列一致性的判断」；若发现不一致，先输出观察（差异是什么）再 ask_user 或报告，不要静默继续。

6. **资源意识**：大数据量时分批处理（每批 ≤500 行），避免单次操作超出工具能力。
   - **Think-Act**：决定分批时，推理中说明「总行数、每批大小、为什么选该批次」；每批完成后观察本批结果再决定下一批参数。
