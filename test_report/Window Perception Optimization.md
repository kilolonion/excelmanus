# 对话上下文总结：窗口感知优化（Window Perception Optimization）

---

## 一、核心 Idea 提出与价值论证

用户提出了一个**窗口感知**概念：模拟人类操作 Excel 时的视觉体验，为 Agent 构建类人的空间感知框架。

**核心痛点**：
- Token 爆炸（全量读取大表格）
- 缺乏空间感（Agent 不知道"正在看哪里"）
- 样式信息丢失（颜色、边框、合并单元格等视觉线索）
- 多表关联困难

**核心价值**：符合认知隐喻、Token 高效、丰富感知、多窗口并行、可解释性强。本质是 **Spreadsheet-Grounded Agent Perception**——表格领域的视觉接地。

---

## 二、概念澄清与共识达成

经过多轮讨论，双方达成关键共识：

| 错误理解 | 正确理解 |
|---------|---------|
| 窗口是 Agent 调用的**工具** | 窗口是注入给 Agent 的**感知环境** |
| Agent 主动管理视口 | 感知层自动决定视口内容 |
| 增加 Agent 决策负担 | 对 Agent 完全透明，零额外成本 |

**感知的信号来源**：不需要猜测，100% 从 Agent 已执行的工具调用中提取。感知是**操作的副作用**，不是预测的结果。

**窗口状态机时序**：
```
打开电脑（桌面/目录视图）→ Agent 调用工具 → 感知层拦截推断 → 下一轮注入渲染好的窗口状态
```
对应人类行为的"操作→抬头看屏幕→开始想下一步"的自然间隙。

---

## 三、三层感知架构设计

| 层级 | 名称 | 来源 | 注入点 | 成本 |
|------|------|------|--------|------|
| **第一层** | 静态感知（桌面视图） | scan/list_dir 包装 | 系统指令 | 一次性 200-500t |
| **第二层** | 实时感知（工具返回值增强） | 程序感知拦截工具调用 | 工具返回值 | 每次 +200-500t |
| **第三层** | 反思感知（小模型优化） | 小模型分析任务+窗口状态 | 下轮系统指令 | ~100t 输入输出 |

**桌面视图**复用 scan 工具粗扫，Agent "睁眼就能看到"文件列表 + 文件摘要（sheet 列表、首行采样），省去 `list_dir` 调用。

**小模型**的不可替代能力仅两个：
1. **任务意图分类**（6 种枚举：DATA_COMPARISON / FORMAT_CHECK / FORMULA_DEBUG 等）
2. **工作记忆管理**（多窗口 token 预算分配：keep / minimize / close）

小模型采用**条件触发**而非每轮调用，成本可忽略（< $0.0001/次）。

**"睁眼可见"标准**：人类打开 Excel 正常能看到的都给（值、基本样式、sheet 标签、滚动条位置等），需要右键等额外操作才能看到的不给。

---

## 四、Phase 1 实现与代码审阅

用户完成了初步实现，新增模块 `excelmanus/window_perception/`：
- `models.py` — 数据模型（WindowState、Viewport、PerceptionBudget）
- `rules.py` — 工具→窗口类型映射规则
- `extractor.py` — 从工具返回值提取元信息
- `budget.py` — Token 预算分配
- `renderer.py` — 窗口状态渲染
- `manager.py` — 窗口管理器（状态机核心）

**代码审阅结果**：整体质量高，发现 3 个需修复问题：
1. `renderer.py` 缺少 `sheet_tabs` 渲染
2. `manager.py` 对 JSON 结果直接修改结构（应统一走文本追加）
3. `_turn` 语义错位（操作序号 vs 对话轮次）

---

## 五、AB 对比测试 — 简单场景

3 个简单用例（基础读取、多 sheet 发现、跨表操作），结果：
- **无害验证通过**：行为路径完全一致，token 仅增加 2-3%
- **工具返回值增强已生效**：`───环境感知───` 块正常注入
- **价值在多轮对话中才体现**：简单场景太短，窗口感知优势未显现

---

## 六、AB 对比测试 — 多轮复杂场景（Phase 1）

3 个多轮用例（跨 sheet 结构探查、多 sheet 切换、渐进式分析），**关键成果**：

| 指标 | OFF | ON | 改善 |
|------|-----|----|----|
| **总 tokens** | 148,160 | 141,192 | **-4.7%** |
| **总工具调用** | 12 | 8 | **-33%** |
| **工具失败** | 1 | 0 | **-100%** |

**最大胜利（wp_cx_03）**：token -69%，迭代 -67%，Agent 直接从窗口上下文回答列名问题，零工具调用。

**发现问题**：wp_cx_01 出现 token 膨胀 +55%（3 轮 × 2 窗口累积注入），budget 策略不够激进。

---

## 七、Phase 1.5 — 窗口生命周期管理

借鉴 **iOS App Lifecycle** 设计四级状态机：

| 状态 | 类比 | idle_turns | tokens | 内容 |
|------|------|-----------|--------|------|
| **ACTIVE** | 前台 App | 0 | 400-800 | 完整预览+样式+滚动条 |
| **BACKGROUND** | 最近任务缩略图 | 1-2 | 80-150 | 列名+行列数+tabs |
| **SUSPENDED** | 任务栏图标 | 3-4 | 20-40 | 一行摘要 |
| **TERMINATED** | 系统回收 | ≥5 | 0 | dormant，缓存保留可恢复 |

**任何状态被工具再次访问 → 立即恢复 ACTIVE。**

小模型兼容设计：`WindowLifecycleAdvisor` 统一接口，Phase 1.5 用 `RuleBasedAdvisor`，Phase 2 切换 `SmallModelAdvisor`，零改主流程。

---

## 八、Phase 1.5 测试验证

### 专项复杂测试

| 指标 | OFF | ON（Phase 1.5） | 改善 |
|------|-----|-----------------|------|
| **总 tokens** | 185,436 | 121,985 | **-34.2%** |
| **总工具调用** | 26 | 8 | **-69.2%** |
| **平均迭代** | 7.33 | 5.00 | **-31.8%** |
| **总耗时** | 263.2s | 184.2s | **-30%** |

wp_cx_01 从 Phase 1 的 78,079t 降至 52,723t（**-32.5%**），token 膨胀问题解决。

### 多维度综合测试（4 个套件 × 2 模式）

| 维度 | 结论 |
|------|------|
| **基础读取类** | 无害，+2% token |
| **数据分析类** | 表面 +135% token，实为**正向变化**：ON 模式直接完成任务而非生成 plan |
| **跨表操作类** | 工具调用 -33% |
| **多轮对话** | 有效用例持平，部分用例因 API 429 限流失败（测试基础设施问题） |

---

## 九、当前状态与后续方向

### ✅ 已完成
- Phase 1：窗口感知核心模块实现 + 引擎接入
- Phase 1.5：四级窗口生命周期（ACTIVE → BACKGROUND → SUSPENDED → TERMINATED）
- AB 测试验证：简单场景无害，多轮复杂场景显著改善

### 🚀 后续方向
1. **测试基础设施**：bench 增加 `--rate-limit`，引入"任务完成度"指标
2. **Phase 2 小模型接入**：`WindowLifecycleAdvisor` 接口已就位，实现 `SmallModelAdvisor`
3. **安全审查**：确认窗口感知提升 Agent 自信度后，不会绕过写入操作的安全审批