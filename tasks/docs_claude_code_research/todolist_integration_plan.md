# ä»»åŠ¡æ¸…å•å·¥å…·ç§¯æè°ƒç”¨ï¼šä¸ ExcelManus é›†æˆæ–¹æ¡ˆ

> **æ—¥æœŸ**ï¼š2026-02-13
> **å‰ç½®ç ”ç©¶**ï¼štodolist_tool_design.md
> **ç›®æ ‡**ï¼šè®© ExcelManus çš„ AI åœ¨å¤æ‚ä»»åŠ¡ä¸­ä¸»åŠ¨ã€é¢‘ç¹åœ°ä½¿ç”¨ task_create / task_update å·¥å…·

---

## ä¸€ã€å½“å‰é¡¹ç›®ç°çŠ¶è¯Šæ–­

### 1.1 å·²æœ‰åŸºç¡€è®¾æ–½ï¼ˆâœ… å¯ç›´æ¥å¤ç”¨ï¼‰

| ç»„ä»¶ | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| **æ•°æ®æ¨¡å‹** | `task_list.py` | TaskStore / TaskList / TaskItem / TaskStatusï¼ˆpending/in_progress/completed/failedï¼‰ï¼Œå«çŠ¶æ€è½¬æ¢æ ¡éªŒ |
| **å·¥å…·å‡½æ•°** | `tools/task_tools.py` | `task_create` + `task_update`ï¼Œå·²æ³¨å†Œåˆ° ToolRegistry |
| **å¼•æ“é›†æˆ** | `engine.py:178-180` | TaskStore åœ¨ AgentEngine.__init__() ä¸­åˆå§‹åŒ–ï¼Œtask_tools å·²æ³¨å…¥ |
| **äº‹ä»¶å‘å°„** | `engine.py:1313-1336` | task_create/task_update æˆåŠŸåå‘å°„ TASK_LIST_CREATED / TASK_ITEM_UPDATED äº‹ä»¶ |
| **UI æ¸²æŸ“** | `renderer.py` | ä»»åŠ¡çŠ¶æ€å›¾æ ‡æ˜ å°„ï¼ˆâ¬œğŸ”„âœ…âŒï¼‰ï¼Œä»»åŠ¡é¢æ¿æ¸²æŸ“ |

### 1.2 æ ¸å¿ƒé—®é¢˜è¯Šæ–­ï¼ˆâŒ éœ€è¦ä¿®å¤ï¼‰

#### é—®é¢˜1ï¼šå·¥å…·æè¿°è¿‡äºç®€å•ï¼Œç¼ºä¹ä½¿ç”¨å¼•å¯¼

å½“å‰ `tools/task_tools.py` ä¸­çš„å·¥å…·æè¿°ï¼š

```python
# task_create
description="åˆ›å»ºä»»åŠ¡æ¸…å•ï¼Œå°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºæœ‰åºå­ä»»åŠ¡åˆ—è¡¨"

# task_update
description="æ›´æ–°ä»»åŠ¡é¡¹çŠ¶æ€ï¼ˆpending â†’ in_progress â†’ completed/failedï¼‰"
```

**å¯¹æ¯” Claude Code** çš„ TodoWrite å·¥å…·æè¿°æœ‰ ~600 token çš„è¯¦ç»†å¼•å¯¼ï¼ˆWhen to Use / When NOT to Use / Task States / Task Management / Task Completion Requirements / Task Breakdown + å…œåº•å¥ "When in doubt, use this tool."ï¼‰ï¼ŒExcelManus çš„æè¿°ä»… ~30 å­—ï¼Œ**å®Œå…¨æ²¡æœ‰ä½¿ç”¨å¼•å¯¼**ã€‚

#### é—®é¢˜2ï¼šSkillpack è·¯ç”±å task å·¥å…·å¯èƒ½è¢«æ’é™¤

åœ¨ `engine.py:_get_current_tool_scope()` ä¸­ï¼š
- å½“ `active_skill` æ¿€æ´»æˆ– `slash_direct` æ¨¡å¼æ—¶ï¼Œtool_scope **ä¸¥æ ¼é™å®šä¸º Skillpack çš„ allowed_tools + select_skill**
- æ‰€æœ‰ Skillpack çš„ `allowed_tools` å‡**ä¸åŒ…å«** task_create / task_update
- ç»“æœï¼š**ä¸€æ—¦è¿›å…¥æŠ€èƒ½è·¯ç”±ï¼Œtask å·¥å…·å°±ä¸å¯ç”¨äº†**

è¿™ä¸ `select_skill`ã€`delegate_to_subagent` ç­‰å…ƒå·¥å…·ä¸åŒâ€”â€”å®ƒä»¬è¢« `_META_TOOL_NAMES` ä¿æŠ¤ï¼Œå§‹ç»ˆè¢«è¿½åŠ åˆ° scopeã€‚

#### é—®é¢˜3ï¼šç³»ç»Ÿæç¤ºè¯ç¼ºå°‘ä»»åŠ¡ç®¡ç†ç« èŠ‚

`memory.py:_DEFAULT_SYSTEM_PROMPT` æœ‰"å·¥ä½œå¾ªç¯"ã€"å·¥å…·ç­–ç•¥"ã€"å®‰å…¨ç­–ç•¥"ç­‰ç« èŠ‚ï¼Œä½†**æ²¡æœ‰ä»»åŠ¡ç®¡ç†ç« èŠ‚**ã€‚å·¥ä½œå¾ªç¯ä¸­çš„"è®¡åˆ’"æ­¥éª¤ä»…è¯´"ç»™å‡ºç®€æ˜çš„æ‰§è¡Œæ­¥éª¤"ï¼Œæ²¡æœ‰å¼•å¯¼ä½¿ç”¨ task_createã€‚

#### é—®é¢˜4ï¼šæ— æœ«å°¾é”šå®š

ç³»ç»Ÿæç¤ºè¯çš„æœ«å°¾æ˜¯"ä¿æŒç®€æ´ï¼Œé¿å…å†—é•¿çš„èƒŒæ™¯è§£é‡Š"ï¼Œæ²¡æœ‰ä»»ä½•å…³äºä»»åŠ¡ç®¡ç†å·¥å…·çš„é”šå®šæé†’ã€‚

---

## äºŒã€å…·ä½“ä¿®æ”¹æ–¹æ¡ˆ

### ä¿®æ”¹1ï¼šå¢å¼ºå·¥å…·æè¿°ï¼ˆtask_tools.pyï¼‰

**æ–‡ä»¶**ï¼š`excelmanus/tools/task_tools.py`
**æ”¹åŠ¨ä½ç½®**ï¼š`get_tools()` å‡½æ•°ä¸­çš„ `description` å­—æ®µ

#### task_create æè¿°å¢å¼º

```python
description=(
    "åˆ›å»ºä»»åŠ¡æ¸…å•ï¼Œå°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸ºæœ‰åºå­ä»»åŠ¡åˆ—è¡¨ã€‚"
    "åœ¨ä»¥ä¸‹åœºæ™¯ä¸»åŠ¨ä½¿ç”¨æ­¤å·¥å…·ï¼š\n"
    "1. ç”¨æˆ·è¯·æ±‚æ¶‰åŠ 3 ä¸ªæˆ–ä»¥ä¸Šæ“ä½œæ­¥éª¤æ—¶\n"
    "2. éœ€è¦è¯»å–å¤šä¸ªæ–‡ä»¶/sheet å¹¶ç»¼åˆåˆ†ææ—¶\n"
    "3. ç”¨æˆ·ä¸€æ¬¡æå‡ºå¤šä¸ªç›¸å…³ä»»åŠ¡æ—¶\n"
    "4. æ“ä½œæ¶‰åŠå†™å…¥ä¸”éœ€è¦å…ˆè¯»å–ç¡®è®¤æ—¶\n"
    "ä¸éœ€è¦ä½¿ç”¨çš„åœºæ™¯ï¼šå•ä¸€ç®€å•æ“ä½œï¼ˆå¦‚ä»…è¯»å–ä¸€ä¸ªæ–‡ä»¶ã€å›ç­”ä¸€ä¸ªé—®é¢˜ï¼‰ã€‚"
),
```

#### task_update æè¿°å¢å¼º

```python
description=(
    "æ›´æ–°ä»»åŠ¡é¡¹çŠ¶æ€ã€‚å¼€å§‹æ‰§è¡ŒæŸä»»åŠ¡å‰æ ‡è®°ä¸º in_progressï¼Œ"
    "å®Œæˆåç«‹å³æ ‡è®°ä¸º completedã€‚\n"
    "è§„åˆ™ï¼š\n"
    "- åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä»»åŠ¡å¤„äº in_progress\n"
    "- å®Œæˆä¸€ä¸ªä»»åŠ¡åç«‹å³æ›´æ–°ï¼Œä¸è¦æ‰¹é‡æ ‡è®°\n"
    "- é‡åˆ°é˜»å¡æˆ–é”™è¯¯æ—¶ä¿æŒ in_progressï¼Œä¸è¦æ ‡è®°ä¸º completed\n"
    "- å‘ç°æ–°çš„å­ä»»åŠ¡æ—¶ï¼Œä½¿ç”¨ task_create é‡æ–°è§„åˆ’"
),
```

### ä¿®æ”¹2ï¼štask å·¥å…·æå‡ä¸º"å‡†å…ƒå·¥å…·"ï¼ˆengine.pyï¼‰

**æ–‡ä»¶**ï¼š`excelmanus/engine.py`
**æ”¹åŠ¨ä½ç½®**ï¼š`_get_current_tool_scope()` æ–¹æ³•

å°† task_create / task_update åŠ å…¥ä¸€ä¸ªæ–°å¸¸é‡ `_ALWAYS_AVAILABLE_TOOLS`ï¼Œä½¿å…¶åœ¨ä»»ä½•è·¯ç”±æ¨¡å¼ä¸‹éƒ½å¯ç”¨ï¼š

```python
# æ–‡ä»¶é¡¶éƒ¨å¸¸é‡åŒº
_META_TOOL_NAMES = ("select_skill", "delegate_to_subagent", "list_subagents")
_ALWAYS_AVAILABLE_TOOLS = ("task_create", "task_update")  # æ–°å¢
```

åœ¨ `_get_current_tool_scope()` çš„æ¯ä¸ª return åˆ†æ”¯å‰ï¼Œç¡®ä¿ task å·¥å…·è¢«è¿½åŠ ï¼š

```python
def _get_current_tool_scope(self, route_result=None):
    # ... ç°æœ‰é€»è¾‘ ...
    # åœ¨æ¯ä¸ª return scope ä¹‹å‰ï¼š
    for tool_name in _ALWAYS_AVAILABLE_TOOLS:
        if tool_name not in scope:
            scope.append(tool_name)
    return scope
```

### ä¿®æ”¹3ï¼šç³»ç»Ÿæç¤ºè¯å¢åŠ ä»»åŠ¡ç®¡ç†ç« èŠ‚ï¼ˆmemory.pyï¼‰

**æ–‡ä»¶**ï¼š`excelmanus/memory.py`
**æ”¹åŠ¨ä½ç½®**ï¼š`_DEFAULT_SYSTEM_PROMPT` å­—ç¬¦ä¸²

åœ¨"å·¥å…·ç­–ç•¥"å’Œ"å®‰å…¨ç­–ç•¥"ä¹‹é—´æ’å…¥æ–°çš„"ä»»åŠ¡ç®¡ç†"ç« èŠ‚ï¼š

```python
"## ä»»åŠ¡ç®¡ç†\n"
"- å¤æ‚ä»»åŠ¡ï¼ˆ3æ­¥ä»¥ä¸Šï¼‰å¼€å§‹å‰ï¼Œä½¿ç”¨ task_create åˆ›å»ºä»»åŠ¡æ¸…å•ã€‚\n"
"- å¼€å§‹æ‰§è¡ŒæŸæ­¥å‰æ ‡è®° in_progressï¼Œå®Œæˆåç«‹å³æ ‡è®° completedã€‚\n"
"- åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªå­ä»»åŠ¡å¤„äºæ‰§è¡Œä¸­ã€‚\n"
"- å¦‚æœä¸è§„åˆ’å°±æ‰§è¡Œï¼Œå¯èƒ½é—æ¼å…³é”®æ­¥éª¤â€”â€”è¿™æ˜¯ä¸å¯æ¥å—çš„ã€‚\n\n"
```

### ä¿®æ”¹4ï¼šæœ«å°¾é”šå®šï¼ˆmemory.pyï¼‰

**æ–‡ä»¶**ï¼š`excelmanus/memory.py`
**æ”¹åŠ¨ä½ç½®**ï¼š`_DEFAULT_SYSTEM_PROMPT` æœ€åä¸€è¡Œ

åœ¨ç³»ç»Ÿæç¤ºçš„æœ«å°¾è¿½åŠ é”šå®šå¥ï¼ˆåˆ©ç”¨ recency biasï¼‰ï¼š

```python
"é‡è¦ï¼šå¤šæ­¥éª¤ä»»åŠ¡ä¸­å§‹ç»ˆä½¿ç”¨ task_create å’Œ task_update è¿½è¸ªè¿›åº¦ã€‚"
```

---

## ä¸‰ã€ä¿®æ”¹å½±å“è¯„ä¼°

### 3.1 æ–‡ä»¶å˜æ›´æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | æ”¹åŠ¨é‡ | é£é™© |
|------|----------|--------|------|
| `tools/task_tools.py` | æè¿°å¢å¼º | ~20 è¡Œ | ğŸŸ¢ ä½ï¼ˆçº¯å­—ç¬¦ä¸²ï¼‰ |
| `engine.py` | å¸¸é‡+scope é€»è¾‘ | ~10 è¡Œ | ğŸŸ¡ ä¸­ï¼ˆå½±å“å·¥å…·å¯è§æ€§ï¼‰ |
| `memory.py` | ç³»ç»Ÿæç¤ºè¯è¿½åŠ  | ~8 è¡Œ | ğŸŸ¢ ä½ï¼ˆè¿½åŠ ï¼Œä¸ä¿®æ”¹ç°æœ‰ï¼‰ |

### 3.2 å‘åå…¼å®¹æ€§

- âœ… ä¸ä¿®æ”¹ TaskStore / TaskItem / TaskList æ•°æ®æ¨¡å‹
- âœ… ä¸ä¿®æ”¹å·¥å…·å‡½æ•°ç­¾åï¼ˆtask_create / task_updateï¼‰
- âœ… ä¸ä¿®æ”¹äº‹ä»¶å‘å°„é€»è¾‘
- âœ… ä¸ä¿®æ”¹ renderer
- âš ï¸ `_get_current_tool_scope` ä¼šè®© task å·¥å…·åœ¨æ‰€æœ‰æ¨¡å¼ä¸‹å¯ç”¨ï¼Œéœ€è¦æµ‹è¯•ç¡®ä¿ Skillpack è·¯ç”±ä¸å—å½±å“

### 3.3 å¯¹ç°æœ‰æµ‹è¯•çš„å½±å“

éœ€è¦æ›´æ–°çš„æµ‹è¯•ï¼š
- `test_tool_scope` ç›¸å…³ç”¨ä¾‹ï¼ˆå¦‚æœ‰ï¼‰ï¼štask å·¥å…·ç°åœ¨å§‹ç»ˆåœ¨ scope ä¸­
- `test_task_tools.py`ï¼ˆå¦‚æœ‰ï¼‰ï¼šæè¿°å­—æ®µå˜æ›´

### 3.4 Token å¼€é”€å¢åŠ 

| ç»„ä»¶ | å½“å‰ token | ä¿®æ”¹å token | å¢é‡ |
|------|-----------|-------------|------|
| task_create description | ~15 | ~80 | +65 |
| task_update description | ~20 | ~80 | +60 |
| ç³»ç»Ÿæç¤ºè¯ï¼ˆä»»åŠ¡ç®¡ç†èŠ‚ï¼‰ | 0 | ~50 | +50 |
| ç³»ç»Ÿæç¤ºè¯ï¼ˆæœ«å°¾é”šå®šï¼‰ | 0 | ~25 | +25 |
| **åˆè®¡** | ~35 | ~235 | **+200** |

~200 token çš„å¢é‡åœ¨ 128K ä¸Šä¸‹æ–‡çª—å£ä¸­å¯å¿½ç•¥ã€‚

---

## å››ã€å®æ–½é¡ºåº

```
Step 1: tools/task_tools.py â€” å¢å¼ºå·¥å…·æè¿°ï¼ˆæœ€ä½é£é™©ï¼Œç«‹å³ç”Ÿæ•ˆï¼‰
Step 2: memory.py â€” ç³»ç»Ÿæç¤ºè¯åŠ å…¥ä»»åŠ¡ç®¡ç†ç« èŠ‚ + æœ«å°¾é”šå®š
Step 3: engine.py â€” task å·¥å…·æå‡ä¸ºå‡†å…ƒå·¥å…·ï¼ˆscope ä¿®æ”¹ï¼‰
Step 4: è¿è¡Œæµ‹è¯•éªŒè¯ + æ‰‹åŠ¨æµ‹è¯•å¤æ‚ä»»åŠ¡åœºæ™¯
```

---

## äº”ã€éªŒè¯æ–¹æ³•

### æ‰‹åŠ¨æµ‹è¯•ç”¨ä¾‹

| æµ‹è¯•åœºæ™¯ | é¢„æœŸè¡Œä¸º | éªŒè¯ç‚¹ |
|----------|----------|--------|
| "å¸®æˆ‘åˆ†æé”€å”®æ•°æ®å¹¶ç”Ÿæˆå›¾è¡¨" | AI å…ˆ task_create åˆ›å»º 2-3 æ­¥æ¸…å•ï¼Œå†é€æ­¥æ‰§è¡Œ | task_create è¢«è°ƒç”¨ |
| "è¯»å–è¿™ä¸ªæ–‡ä»¶" | AI ç›´æ¥è¯»å–ï¼Œä¸åˆ›å»º task_create | ç®€å•ä»»åŠ¡ä¸è¿‡åº¦è°ƒç”¨ |
| "/chart_basic ç”»ä¸€ä¸ªæŸ±çŠ¶å›¾" | Skillpack è·¯ç”±åï¼Œtask å·¥å…·ä»å¯ç”¨ | scope ä¿®å¤ç”Ÿæ•ˆ |
| å¤šæ­¥éª¤æ‰§è¡Œä¸­æ¯å®Œæˆä¸€æ­¥ | ç«‹å³è°ƒç”¨ task_update æ ‡è®° completed | å®æ—¶æ›´æ–° |

### è‡ªåŠ¨åŒ–æµ‹è¯•

```python
# éªŒè¯ task å·¥å…·å§‹ç»ˆåœ¨ scope ä¸­
def test_task_tools_always_in_scope():
    """task_create/task_update åœ¨æ‰€æœ‰è·¯ç”±æ¨¡å¼ä¸‹éƒ½åº”è¯¥å¯ç”¨ã€‚"""
    engine = create_test_engine()
    # æ¨¡æ‹Ÿå„ç§è·¯ç”±æ¨¡å¼
    for mode in ["fallback", "slash_direct", "active_skill"]:
        scope = engine._get_current_tool_scope(...)
        assert "task_create" in scope
        assert "task_update" in scope
```
